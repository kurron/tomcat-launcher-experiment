import org.kurron.tomcat.ShutdownMonitor
import org.kurron.tomcat.Tomcat7xServer
import org.kurron.tomcat.TomcatServer

apply plugin: 'groovy'
apply plugin: 'project-report'

defaultTasks 'clean', 'projectReport', 'build'

repositories {
    mavenCentral()
}

task wrapper(type: Wrapper) {
    gradleVersion = '1.8'
}

apply plugin: GreetingPlugin

tomcat {
    message = 'Hi'
    greeter = 'Gradle'
}

class GreetingPlugin implements Plugin<Project> {
    void apply(Project project) {
        project.extensions.create("tomcat", TomcatPluginExtension)
        project.task('hello') << {
            println "${project.tomcat.message} from ${project.tomcat.greeter}"
            TomcatServer server = new Tomcat7xServer()
            String path = new File( 'rest-services-1.0.0-SNAPSHOT.war' ).canonicalPath
            println( "path = ${path}")
            server.createContext( '/rest-services', path )
            server.createLoader(Thread.currentThread().contextClassLoader)
            server.start()
            boolean daemon = false

            Thread shutdownMonitor = new ShutdownMonitor( 8081, 'stop-key', server, daemon)
            shutdownMonitor.start()

            if(!daemon) {
                shutdownMonitor.join()
            }
        }
    }
}

class TomcatPluginExtension {
    String message
    String greeter
}
